import json # bruker json fordi det er en tydelig struktur, bedre for lister og objekter enn .txt

# self peker på det nye objektet som lages
# det som skjer i bakgrunnen er at python oppretter values i objektets ordbok
class Emne: # oppskriften for objekter, i dette tilfellet er objektet emne("dat120", "grun prog", "h", 10)
    def __init__(self, kode, navn, semester, studiepoeng): # konstruktør. kjøres når et nytt objekt lages av emne
        self.kode = kode        # lagrer emnekoden
        self.navn = navn        # lagrer navn på emnet
        self.semester = semester.upper()  # lagrer semester i store bokstaver
        self.studiepoeng = studiepoeng    # lagrer antall studiepoeng
# funksjon for å få skrevet ut objektet som tekst, med kode, navn, semester og studiepoeng
# __str__ fordi det gir en ryddig og forståelig utskrift av objektene, spesielt i menyer
    def __str__(self):
        return f"{self.kode} - {self.navn} ({self.semester}, {self.studiepoeng} sp)"


# ny klasse for hver studieplan, hver plan har en unik ID, plan_id
class Studieplan:
    def __init__(self, plan_id, tittel):
        self.plan_id = plan_id      # unik id for studieplan
        self.tittel = tittel        # tittel på studieprogrammet
        # 6 semestre: 1, 2, 3, 4, 5, 6 i en ordbok, dictionary, verdiene er tomme lister
        # som skal inneholde emnekodene
        
        # hver nøkkel peker på en separat liste, der hver liste inneholder emnene
        #i det enkelte semesteret. Det vil se noe slik ut:
        # {1: ["dat100", "dat200", "dat300"], 2: [], 3: [], 4: [], 5: [], 6: []}
        self.semestre = {i: [] for i in range(1, 7)}  # dictionary comprehension, løkke kjøres 6 ganger

# legge til et emne til et semester
# passer på at emner tiltenkt høstsemester kun passer i 1, 3, og 5
#  og vårsemester kun passer i 2, 4, 6
    def legg_til_emne(self, emne, semester):
        # sjekk at semester er gyldig for emnet
        if emne.semester == 'H' and semester not in [1, 3, 5]:
            print("Feil: Høstemner kan bare legges i 1., 3. eller 5. semester.")
            return
        if emne.semester == 'V' and semester not in [2, 4, 6]:
            print("Feil: Våremner kan bare legges i 2., 4. eller 6. semester.")
            return

        # sjekk om emnet allerede er lagt til
        # løkken går gjennom alle listene i self.semestre
        # sjekker f.eks om "dat100" finnes
        # dette forhindrer at det samme emnet kan legges til i studieplan flere ganger
        for sem in self.semestre.values():
            if emne.kode in sem:
                print("Dette emnet er allerede i studieplanen.")
                return

        # sjekk at det er plass (maks 30 studiepoeng)
        #list comprehension/generator
        # Går gjennom alle emner, velger de som er relevant for semesteret, 
        # samler studiepoengene til dem, og summerer
        # e er en midlertidig variabel som representerer ett emneobjekt om gangen
        
        total_sp = sum(e.studiepoeng for e in emner if e.kode in self.semestre[semester])
        if total_sp + emne.studiepoeng > 30:
            print("Feil: For mange studiepoeng i dette semesteret (maks 30).")
            return

        # hvis alt er ok, legges emnet til i semesteret
        # henter listen [semester] for det spesifikke semesteret, appender emnekoden
        # lagrer kun emnekoden siden json ikke lagrer objekter direkte uten konvertering
        self.semestre[semester].append(emne.kode)
        print(f"Emnet {emne.kode} ble lagt til i semester {semester}.")

    # ser gjennom alle semestre, hvis emnekoden finnes, fjernes den
    def fjern_emne(self, emnekode):
        for sem, emneliste in self.semestre.items(): # items gir nøkkel (sem) og verdi (emneliste)
            if emnekode in emneliste:
                emneliste.remove(emnekode)
                print(f"Emnet {emnekode} ble fjernet fra semester {sem}.")
                return
        print("Emnet finnes ikke i denne studieplanen.")

# sjekker alle semestre, og summerer opp studiepoeng per semester
# hvis studiepoeng ulik 30, ikke gyldig, ellers returneres gyldig lik true
    def er_gyldig(self):
        gyldig = True
        for sem, emnekoder in self.semestre.items():
            total_sp = sum(e.studiepoeng for e in emner if e.kode in emnekoder)
            if total_sp != 30:
                print(f"Semester {sem} har {total_sp} studiepoeng (bør være 30).")
                gyldig = False
        return gyldig

# oversikt over studieplanen i tekstform
# for hvert semester, skriver ut semesteroverskrift
# 
    def __str__(self):
        tekst = f"\nStudieplan: {self.tittel} (ID: {self.plan_id})\n"
        for sem, emnekoder in self.semestre.items():
            tekst += f"Semester {sem}:\n"
            for kode in emnekoder:
                # finn første emneobjekt med riktig kode, eller none hvis den ikke finnes
                emne = next((e for e in emner if e.kode == kode), None)
                if emne:
                    tekst += f"  - {emne}\n"
            if not emnekoder:
                tekst += "  (Ingen emner)\n"
        return tekst

emner = []           # liste med Emne-objekter
studieplaner = []    # liste med Studieplan-objekter

def lag_emne(emner):
    kode = input("Emnekode: ")
    navn = input("Navn: ")
    semester = input("Semester (H/V): ")
    studiepoeng = int(input("Studiepoeng: "))
    nytt_emne = Emne(kode, navn, semester, sp)
    emner.append(nytt_emne)
    print("Emne opprettet!")

def lagre_til_fil():
    data = {
        "emner": [e.to_dict() for e in alle_emner],
        "studieplaner": [s.to_dict() for s in alle_studieplaner}
    with open("data.json", "w", encoding="utf-8") as f:
        json.dump(data, f, indent=4, ensure_ascii=False)
    print("Data lagret til 'data.json'!")
def les_fra_fil():
    global alle_emner, alle_studieplaner
    try:
        with open("data.json", "r", encoding="utf-8") as f:
            data = json.load(f)
        alle_emner = [Emne.from_dict(e) for e in data["emner"]]
        alle_studieplaner = [Studieplan.from_dict(s, alle_emner) for s in data["studieplaner"]]
        print("Data lest inn fra 'data.json'!")
    except FileNotFoundError:
        print("Fant ikke 'data.json'. Du må lagre data først.")







def hovedmeny():
    while True:
        print("----- MENY -----")
        print("1. Lag et nytt emne")
        print("2. Legg til et emne i en studieplan")
        print("3. Fjern et emne fra en studieplan")
        print("4. Skriv ut ei liste over alle registrerte emner")
        print("5. Lag en ny tom studieplan")
        print("6. Skriv ut en studieplan med hvilke emner som er i hvert semester")
        print("7. Sjekk om en studieplan er gyldig eller ikke")
        print("8. Finn hvilke studieplaner som bruker et oppgitt emne")
        print("9. Lagre emnene og studieplanene til fil")
        print("10. Les inn emnene og studieplanene fra fil")
        print("11. Avslutt")
        print("-----------------")
        valg = input("Velg et tall: ")

        if valg == "1":
            lag_emne()
        elif valg == "2":
            legg_til_emne_i_plan()
        elif valg == "3":
            fjern_emne_fra_plan()
        elif valg == "4":
            skriv_ut_emner()
        elif valg == "5":
            lag_studieplan()
        elif valg == "6":
            skriv_ut_plan()
        elif valg == "7":
            sjekk_plan_gyldig()
        elif valg == "8":
            finn_planer_med_emne()
        elif valg == "9":
            lagre_til_fil()
        elif valg == "10":
            les_fra_fil()
        elif valg == "11":
            print("Avslutter...")
            break
        else:
            print("Ugyldig valg. Prøv igjen.")
